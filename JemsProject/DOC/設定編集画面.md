# 📘 設定編集機能 設計書（v1.1 完全版）


---


## 1. 概要


本機能は、システム内で利用される各種設定値（システム設定・メールテンプレート・エラーコード）を統合的に管理し、Web UI から編集・更新・キャッシュ再読み込みを可能にする仕組みである。


更新された設定値は即時反映され、キャッシュの再読み込みによりシステム全体に適用される。


---


## 2. 機能ごとの仕様


---


### 2.1 システム設定（SystemSetting）


#### 🔸 概要


システム全体の挙動に関わる設定値（例：メンテナンスモードやログレベル）を管理する。


#### 🔸 管理項目


| 項目名 | 型     | 説明                             |
| ------ | ------ | -------------------------------- |
| key    | String | 設定キー（例：MAINTENANCE_MODE） |
| value  | String | 設定値                           |


#### 🔸 API


- `GET /settings`
- `PUT /settings`
- `POST /settings/reload`


#### 🔸 キャッシュ仕様


- 起動時に全件ロード
- 更新時はキャッシュを再構築


---


### 2.2 メールテンプレート設定（MailTemplate）


#### 🔸 概要


DB に保存されたメールテンプレート（件名・本文）を編集・保存・キャッシュ再読み込みする機能。テンプレート本文には `{{変数名}}` を使用し、変換後に Thymeleaf テンプレートとして利用される。


#### 🔸 管理項目（DB）


| 項目名       | 型     | 説明                              |
| ------------ | ------ | --------------------------------- |
| templateName | String | テンプレート識別子                |
| locale       | String | 対象ロケール（例：ja）            |
| subject      | String | 件名テンプレート                  |
| body         | String | HTML 本文テンプレート（{{変数}}） |


#### 🔸 管理方式


- テンプレートはすべて DB に保存
- `MailTemplateRegistry` は DB から `templateName` 一覧をキャッシュ
- UI 編集時に対象テンプレートの存在確認として `Registry.exists(name)` を利用可能


#### 🔸 API


- `GET /api/mail-templates`
- `PUT /api/mail-templates/{templateName}`
- `POST /api/mail-templates/reload`
- `POST /api/mail-templates/preview`


#### 🔸 プレビュー仕様


- 編集中のテンプレート＋ダミー変数から実際の HTML・件名を生成し画面に表示
- サーバ側で `{{...}}` を Thymeleaf 構文に変換して評価
- テスト送信等は別仕様書にて定義


---


### 2.3 エラーコード設定（ErrorCode）


#### 🔸 概要


アプリケーションで使用される多言語対応のエラーメッセージを管理する。


#### 🔸 管理項目


| 項目名  | 型     | 説明           |
| ------- | ------ | -------------- |
| code    | String | エラーコード   |
| locale  | String | 対象ロケール   |
| message | String | 表示メッセージ |


#### 🔸 API


- `GET /api/error-codes`
- `POST /api/error-codes`
- `PUT /api/error-codes/{code}`
- `POST /api/error-codes/reload`


#### 🔸 キャッシュ仕様


- 起動時に全件ロード
- 更新後にキャッシュ再構築


---


## 3. 共通キャッシュ制御仕様


### 🔸 共通インターフェース


```java
public interface CacheReloadable {
    void reloadCache();
}
```


各設定種別ごとに `@Component` でキャッシュを管理。更新後は個別に `reloadCache()` を実行。


---


## 4. フロントエンド構成（ワイヤーフレーム）


### 4.1 設定一覧画面


```
+------------------------ 設定画面 ------------------------+
| システム設定                                              |
|----------------------------------------------------------|
| MAINTENANCE_MODE               [ false           ] [変更] |
| LOG_LEVEL                      [ INFO            ] [変更] |
| MAX_LOGIN_ATTEMPTS             [ 5               ] [変更] |
|----------------------------------------------------------|
| メールテンプレート設定                                    |
|----------------------------------------------------------|
| テンプレートキャッシュ再読み込み                  [再読み込み] |
|----------------------------------------------------------|
| ▶ エラーコードの設定変更画面へ                       |
+----------------------------------------------------------+
```


---


### 4.2 メールテンプレート編集画面


```
+------------------- メールテンプレート編集画面 -------------------+
| テンプレート選択: [ user_welcome ▼ ]                            |
| ロケール:         [ ja ▼ ]                                      |
|---------------------------------------------------------------|
| 件名:                                                          |
| [ ようこそ、{{username}} さん ]                                  |
|---------------------------------------------------------------|
| 本文 (HTML + {{変数}} 埋め込み)                                |
|---------------------------------------------------------------|
| <html>                                                         |
|   <body>                                                       |
|     <p>こんにちは、{{username}} さん</p>                         |
|     <p>ログインURL: {{loginUrl}}</p>                            |
|   </body>                                                      |
| </html>                                                        |
|---------------------------------------------------------------|
| [保存] [キャッシュ再読み込み] [ プレビュー ▶ ]                 |
+----------------------------------------------------------------+


[ プレビュー表示エリア ]
+---------------------------------------------------------------+
| 件名: ようこそ、Taro さん                                       |
| 本文:                                                         |
| ------------------------------------------------------------  |
| こんにちは、Taro さん                                          |
| ログインURL: https://example.com/login                        |
| ------------------------------------------------------------  |
+---------------------------------------------------------------+
```


---


### 4.3 エラーコード編集画面


```
+-------------------- エラーコード編集画面 --------------------+


[ 新規追加 ]
+------------+-----------------------------+----------+------+
| Code       | Message                     | Locale   |      |
+------------+-----------------------------+----------+------+
| [ E10003 ] | [ 無効なトークンです ]       | [ ja ]   | [追加] |
+-------------------------------------------------------------+


[ 一覧と編集 ]
+------------+-----------------------------+----------+--------+
| Code       | Message                     | Locale   | 編集   |
+------------+-----------------------------+----------+--------+
| E10001     | ログインに失敗しました       | ja       | [変更] |
| E10001     | Login failed                | en       | [変更] |
| E10002     | パスワードが無効です         | ja       | [変更] |
+---------------------------------------------------------------+


[キャッシュ再読み込み]
```


---


## 5. セキュリティ・認可


| 対象                       | アクセス条件                          |
| -------------------------- | ------------------------------------- |
| 設定全般の閲覧             | 認証済ユーザー                        |
| システム・エラーコード編集 | `ROLE_ADMIN`                          |
| メールテンプレート編集     | `ROLE_ADMIN` または開発者（制限可能） |


---


## 6. 拡張候補


| 項目                       | 説明                                   |
| -------------------------- | -------------------------------------- |
| 設定変更の監査ログ         | 変更履歴の記録（誰が、何を、いつ）     |
| インポート／エクスポート   | JSON 形式で設定を保存・復元            |
| テンプレート変数の補完支援 | 使用可能な `{{変数}}` の一覧表示機能   |
| テストメール送信機能       | 編集中テンプレートの仮送信（別仕様書） |


---


## 7. API 定義詳細


### 7.1 システム設定 API


#### 一覧取得


```
GET /api/settings
```


#### 更新


```
PUT /api/settings
{
  "key": "MAINTENANCE_MODE",
  "value": "true"
}
```


#### キャッシュ再読み込み


```
POST /api/settings/reload
```


---


### 7.2 メールテンプレート API


#### 一覧取得


```
GET /api/mail-templates
```


#### 更新


```
PUT /api/mail-templates/{templateName}
{
  "locale": "ja",
  "subject": "ようこそ、{{username}} さん",
  "body": "<p>こんにちは、{{username}}</p>"
}
```


#### キャッシュ再読み込み


```
POST /api/mail-templates/reload
```


#### プレビュー表示


```
POST /api/mail-templates/preview
{
  "subject": "ようこそ、{{username}} さん",
  "body": "<p>こんにちは、{{username}}</p>",
  "dummyVariables": {
    "username": "Taro",
    "loginUrl": "https://example.com/login"
  }
}
```


---


### 7.3 エラーコード API


#### 一覧取得


```
GET /api/error-codes
```


#### 追加


```
POST /api/error-codes
{
  "code": "E10003",
  "locale": "ja",
  "message": "不正なトークンです"
}
```


#### 更新


```
PUT /api/error-codes/E10001
{
  "locale": "ja",
  "message": "認証に失敗しました"
}
```


#### キャッシュ再読み込み


```
POST /api/error-codes/reload
```


---


## **8. フォルダ構成**


### 2-1. appserver（BatchRunner(ライブラリ)）


- 中量バッチに関しては job 〇〇 △△（jobRunnerService など)を基本名称とし、他のモジュールと差別化する。


```
FE/my-next-app
├── slice
│   └── JobRunner.java              // 実行ロジック（Thread / Executorベース）
├── controller
│   ├── JobRunnerController.java   // RESTで起動
│   ├── EmailTemplateController.java //メールテンプレートのRESTコントローラ

├── repository
│   └── JobStatusRepository.java   // job_status テーブル参照


├── slice
│   ├── settingSlice.ts             // 設定画面のパラメータ定義等
│   ├── emailTemplateSlice.ts       // メールテンプレート画面のパラメータ定義等
│   └── errorCodeSlice.ts       // エラーコード編集画面のパラメータ等


├── hooks
│   ├── useSetting.ts         // メールテンプレート画面
│   ├── mail-templates.tsx         // メールテンプレート画面
│   └── useSetting.ts      // ビジネスロジック
└── page
    ├── settings.tsx               // 画面全体の構成を担当するコンポーネント
    ├── settingItem.tsx            // 各設定項目（MAINTENANCE_MODEなど）の個別コンポーネント
    ├── mail-templates.tsx         // メールテンプレート画面
    └───error-codes.tsx            // エラーコード画面



BE/appserver
├── controller
│   ├── SettingController.java     // React のリクエストに応じて設定を取得・更新する REST コントローラー
│   ├── ErrorCodeController.java   // React のリクエストに応じて設定を取得・更新する REST コントローラー
│   ├── ErrorCodeController.java   // React のリクエストに応じて設定を取得・更新する REST コントローラー


├── repository
│   └── SettingRepository.java     // 設定項目をDBに入れるためのリポジトリ
│   └── ErrorCodeRepository.java   // エラー内容をDBに入れるためのリポジトリ


│── entity
│   └── EmailTemplateEntity.java   // テーブルの値を格納する
├── model
│   └── EmailTemplate.java         // メールテンプレート画面から取得したパラメータを格納する
│   └── ErrorCode.java         // メールテンプレート画面から取得したパラメータを格納する

└── service
　  │── SettingService.java       // 設定画面のビジネスロジック
　  │── EmailTemplateService.java　// メールテンプレートのビジネスロジック
    └── ErrorCodeService.java

退避
└── dto/
│   │   │   │       └── ErrorCodeDTO.java //
